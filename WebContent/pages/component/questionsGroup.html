<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="head">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<title>
葬礼定制
</title>
</head>
<script src="../../js/jquery-2.1.4.js"></script>
<script src="../../js/jquery-ui.js"></script>
<script src="../../js/angular-1.4.0-rc.2/angular.js"></script>
<script src="../../js/Bootstrap/boot.js"></script>
<link href="../../js/Bootstrap/boot.css" rel="stylesheet">
<style>
    body {
	    text-align: center;
	}
    #productMain {
		overflow: hidden;
	}
    #tabCarousel {
	    width: 100%;
		height: 50px;
		border-bottom: 1px solid #e7e7e7
	}
    .productTab {
	    width: 120px;
		height: 50px;
		float: left;
		transition:background 0.2s;
		-moz-transition:background 0.2s;
        -webkit-transition:background 0.2s;
        -o-transition:background 0.2s;
	}
	.productTab:hover {
	    background-color: #B5AFAF;
	}
	.productTab p {
	    font-size: 20px;
		line-height: 50px;
		cursor: pointer;
		color: #707070;
	}
	.carousel-control {
	    width: 15px;
		background-image: none !important;
	}
	.headerArrow {
	    margin-top: 8px;
	}
	.index {
	    width:54px;
		height: 54px;
		border-radius: 27px;
		background-color: #f6f6f6;
		margin: 0 auto;
		margin-top: 28px;
	}
	.index p {
	    line-height: 54px;
		color: #707070;
		margin: 0px;
	}
	.questionCenter {
		overflow: auto;
		text-align: center;
		padding-bottom: 50px;
	}
	.questionCenter h1{
	    font-size: 38px;
		color: #707070;
		margin: 0px;
	}
	.questionText {
		text-align: center;
		width: 522px;
		margin: 0px auto;
		margin-top: 10px;
		margin-bottom: 10px;
	}
	.questionTwo {
	    margin-top: 37px;
		overflow: auto;
		margin-left: 50px;
		float: left;
		padding-bottom: 40px;
	}
	.questionTwoStart {
	    margin-left: 176px!important;
	    padding-bottom: 40px;
	}
	.questionTwo .optionIcon {
	    width: 274px;
		height: 274px;
		border-radius: 137px;
		background-color: #f6f6f6;
	}
	.questionTwo .optionText {
	    width: 274px;
		overflow: auto;
	}
	.questionTwo .optionText p {
	    font-size: 32px;
		line-height:40px;
		margin: 0px;
		color: #707070;
	}
	.questionThree {
	    margin-top: 92px;
		overflow: auto;
		margin-left: 40px;
		float: left;
		padding-bottom: 40px;
	}
	.questionThreeStart {
	    margin-left: 125px!important;
	    padding-bottom: 40px;
	}
	.questionThree .optionIcon {
	    width: 204px;
		height: 204px;
		border-radius: 102px;
		background-color: #f6f6f6;
	}
	.questionThree .optionText {
	    width: 204px;
		overflow: auto;
	}
	.questionThree .optionText p {
	    font-size: 34px;
		line-height: 40px;
		margin: 0px;
		color: #707070;
	}
	.questionFour {
	    margin-top: 61px;
		overflow: auto;
		margin-left: 71px;
		float: left;
		padding-bottom: 40px;
	}
	.questionFourStart {
	    margin-left: 102px!important;
	    padding-bottom: 40px;
	}
	.questionFour .optionIcon {
	    width: 136px;
		height: 136px;
		border-radius: 68px;
		background-color: #f6f6f6;
	}
	.optionIcon {
	    overflow: hidden;
		cursor: pointer;
	}
	.optionIcon:hover {
	    border: 1px solid #ff5274;
		opacity: 0.7;
	}
	.optionIcon img {
	    width: 100%;
		height: 100%;
	}
	.questionFour .optionText {
	    width: 136px;
		overflow: auto;
	}
	.questionFour .optionText p {
	    font-size: 32px;
		line-height: 40px;
		margin: 0px;
		color: #707070;
	}
	.addtionOption {
	    width: 400px;
		margin-top: 40px;
		margin: 0px auto;
	}
	.addtionOption input {
	    width: 400px;
	}
	#rightFooter {
		width: 100%;
		overflow: auto;
		background: #fafafa;
		padding-top: 31px;
		padding-bottom: 31px;
		padding-left: 55px;
		padding-right: 55px;
	}
	#prevStep {
		float: left;
		width: 61px;
		height: 60px;
		background: 
	}
	#nextStep {
		float: right;
		width: 144px;
		height: 60px;
	}
	.operatorButton {
		background: #d6d6d6;
		border-radius: 4px;
		box-shadow: 0 4px 0px 0 #c5c5c5;
		text-align: center;
		cursor: pointer;
	}
	.operatorButton:hover {
		background: #ff5274;
		box-shadow: 0 4px 0px 0 #e6385a;
	}
	.operatorButton p {
		margin: 0px;
		line-height: 60px;
		color: #ffffff;
		font-size: 24px;
	}
	.disabled {
	    opacity: 0.5;
		cursor: default;
		background: #d6d6d6!important;
		box-shadow: 0 4px 0px 0 #c5c5c5!important;
	}
	#moveCursor {
	    width: 120px;
		height: 2px;
		position: absolute;
		background: #ff5274;
	}
	.selected {
	    border: 2px solid #ff5274!important;
	}
	.finishedIcon {
	    width: 16px;
		height: 16px;
		background: #2c9676;
		text-align: center;
		position: absolute;
		border-radius: 8px;
		top: 10px;
		margin-left: 100px;
	}
	.finishedIcon span {
	    color: #ffffff;
		font-size: 6px;
		line-height: 16px;
	}
	#tabSoLong {
        width: 100%;
        overflow: hidden;
        height: 50px;
    }
    #tabSoLong .right {
        left: 930px;
        right: auto;
    }
    #tabSoLong .carousel-control {
        width: 30px;
    }
</style>
<script type="text/javascript">
var app = angular.module('productApp', []);
app.directive('onFinishRenderFilters', function ($timeout) {
    return {
        restrict: 'A',
        link: function(scope, element, attr) {
            if (scope.$last === true) {
                $timeout(function() {
                    scope.$emit('ngRepeatFinished');
                });
            }
        }
    };
});
app.controller('products', function($scope, $http) {
    $http.get("/funeral/question/list").success(function(response) {
    	var count = response.length,
		    singleTabWidth = 120;
	    $("#tabCarousel").css({
	    	'width': count*singleTabWidth+"px"
	    });
	    $("#tabCarousel").find(".right").click(function(event) {
	    	var length = $("#tabCarousel").find(".productTab").length;
	
	    	for (var i = 0; i<length; i++) {
	    		var me = $($("#tabCarousel").find(".productTab")[i]);
	    		if (!me.is(':hidden') && i !== length-1) {
	    			me.hide();
	    			handleCursor($(".cursoredTab"));
	    			return false;
	    		}
	    	}
	    });
	    $("#tabCarousel").find(".left").click(function(event) {
	    	$("#tabCarousel").find(".productTab").each(function(idx) {
	    		var me = $(this);
	    		if (!me.is(':hidden')) {
	    			if (idx > 0) {
	    				me.prev().show();
	    				handleCursor($(".cursoredTab"));
	    				return false;
	    			}
	    		}
	    	});
	    });
		for (var i=0;i<response.length; i++) {
		    var questionJson = response[i];
			for (var j=0; j<questionJson.optionList.length;j++) {
				if (questionJson.optionCount === 2) {
				    questionJson.optionList[j].questionClass= 'questionTwo';
				}
				else if (questionJson.optionCount === 3) {
				    questionJson.optionList[j].questionClass= 'questionThree';
				}
				else if (questionJson.optionCount === 4) {
				    questionJson.optionList[j].questionClass= 'questionFour';
				}

				if (j === 0) {
				    questionJson.optionList[j].questionClass = questionJson.optionList[j].questionClass + " " + questionJson.optionList[j].questionClass + "Start";
				}
			}
		}
		$scope.totalCount = response.length;
		$scope.questions = response;
	});
	$scope.$on('ngRepeatFinished', function (ngRepeatFinishedEvent) {
          $(".questionCenter").first().fadeIn();
		  $(".finishedIcon").each(function() {
		      if ($(this).hasClass("finished")) {
			      $(this).fadeIn();
			  }
		  });
		  $($(".productTab")[0]).addClass("cursored");
		  window.parent.iFrameHeight(1);
		  window.parent.unmusk();
    });
});
</script>
<body ng-app="productApp" ng-controller="products" onselectstart="return false">
<div id="productMain" ng-cloak>
<div id="tabSoLong">
<div id="tabCarousel" class="carousel slide">
<div class="carousel-inner">
    <div class="item active" alt="First slide">
		<div class="productTab" ng-repeat="question in questions" id="{{question.questionId}}">
		    <p>问题{{$index+1}}</p>
			<div class="finishedIcon" hidden><span>&#10004;</span></div>
		</div>
    </div>
</div>
<a class="carousel-control left" href="#tabCarousel" 
    data-slide="prev"><p class="headerArrow">&lsaquo;</p></a>
<a class="carousel-control right" href="#tabCarousel" 
    data-slide="next"><p class="headerArrow">&rsaquo;</p></a>
</div>
<div id="moveCursor">
</div>
</div>
<div class="questionCenter" hidden id="{{question.questionId}}-content" ng-repeat="question in questions" on-finish-render-filters>
    <div class="index">
	    <p><b>{{$index+1}}</b>/{{totalCount}}</p>
	</div>
	<div class="questionText">
	    <h1>{{question.questionContent}}</h1>
	</div>
	<div class="{{option.questionClass}}" ng-repeat="option in question.optionList track by $index">
	    <div class="optionIcon" id="{{option.optionId}}">
		    <img src="../../js/images/{{option.imgUrl}}"></img>
		</div>
		<div class="optionText">
		    <p>{{option.optionDesc}}</p>
		</div>
	</div>
</div>
	<div id="rightFooter">
	    <div id="prevStep" class="operatorButton">
		    <p>&#60;</p>
		</div>
		<div id="nextStep" class="operatorButton">
		    <p>下一步</p>
		</div>
	</div>
</div>
</body>
<script>
function handleFinishButton() {
    var allFinished = true;

    $(".productTab").each(function() {
		if (!$(this).hasClass("finished")) {
		    allFinished = false;
			return false;
		}
	});

	if (allFinished) {
		$("#nextStep").removeClass("disabled");
	}
    else {
		$("#nextStep").addClass("disabled");
    }
}
function handleButton() {
    var count = $(".questionCenter").length,
	    firstSlide = $($(".questionCenter")[0]),
		lastSlide = $($(".questionCenter")[count-1]);
    if (!firstSlide.is(':hidden')) {
	    $("#prevStep").addClass("disabled");
	}
	else {
	    if ($("#prevStep").hasClass("disabled")) {
		    $("#prevStep").removeClass("disabled");
		}
	}

	if (count>0 && !lastSlide.is(':hidden')) {
	    $("#nextStep").find("p")[0].innerText = "完成";
		$("#nextStep").addClass("finishedButton");
	}
    else {
	    $("#nextStep").find("p")[0].innerText = "下一步";
		$("#nextStep").removeClass("finishedButton");
	}
}
function handleCursor(tab, move) {
    var me = tab,
        length = $("#tabCarousel").find(".productTab").length;
    $(".productTab").removeClass("cursoredTab");
    me.addClass("cursoredTab");
    if (!me.is(':hidden')) {
    	$("#moveCursor").show();
    	if (tab.position().left > 900) {
    		if (move === 1) {
	    		var needCancelCount = 8;
	    		$("#tabCarousel").find(".productTab").each(function(idx) {
		    		var me = $(this);
		    		if (!me.is(':hidden')) {
		    			if (needCancelCount > 0 && idx < length - 1) {
		    			    me.hide();
		    			    needCancelCount = needCancelCount - 1;
		    			}
		    			else {
		    				$("#moveCursor").animate({left:'0px'});
		    				return false;
		    			}
		    		}
		    	});
    		}
    		else {
    			$("#moveCursor").hide();
    		}
    	}
    	else {
    		$("#moveCursor").animate({left:tab.position().left+'px'});
    	}
    }
    else {
    	if (move === 1) {
    		var needCancelCount = 8;
    		$("#tabCarousel").find(".productTab").each(function(idx) {
	    		var me = $(this);
	    		if (!me.is(':hidden')) {
	    			if (idx >= 0 && needCancelCount > 0) {
	    				while(needCancelCount > 0) {
	    				    me.prev().show();
	    				    me = me.prev();
	    				    needCancelCount = needCancelCount -1;
	    				}
	    			}
	    			else {
	    				$("#moveCursor").animate({left:'840px'});
	    				return false;
	    			}
	    		}
	    	});
    	}
    	else {
    	    $("#moveCursor").hide();
    	}
    }
}
function handleFinished(tabPage) {
    var count = $(".productTab").length;
	var me = tabPage,
		otherText = tabPage.find("#messageSent")[0].value,
		tabId = tabPage[0].id.replace('-content', '');
		    if (tabPage.find(".selected").length > 0 || otherText !== "") {
		    	$("#"+tabId).find(".finishedIcon").fadeIn();
		    	$("#"+tabId).addClass("finished");
			}
			else {
				$("#"+tabId).find(".finishedIcon").fadeOut();
				$("#"+tabId).removeClass("finished");
			}

	if (tabPage[0] === $(".questionCenter")[count-1]) {
	    handleFinishButton();
	}
}
function generateQuestionList(answetList) {
    $(".questionCenter").each(function() {
	    var answer = {
		    questionId: $(this)[0].id.replace('-content',''),
			optionId: $(this).find(".selected")[0].id,
			answerDesc: $(this).find("#messageSent")[0].value
		};

		answetList.push(answer);
	});
}
$(document.body).on("click",".operatorButton", function( event ) {
	var me = $(this),
	    count =  $(".questionCenter").length;

	if (me.hasClass("disabled")) {
	    return;
	}

	if (me[0].id === 'nextStep') {
	    $(".questionCenter").each(function(idx){
		    if (!$(this).is(':hidden')) {

				if ($(this).next().hasClass('questionCenter')) {
				    $(this).hide();
				    var tabId = $(this).next()[0].id.replace('-content', '');
					handleCursor($("#"+tabId), 1);
	                $(this).next().fadeIn();

					if (idx === count-2) {
					    handleFinishButton();
					}
				}
				return false;        
			}
	    });
	}
	else {
	    $(".questionCenter").each(function(idx){
		    if (!$(this).is(':hidden')) {
	            $(this).hide();
				var tabId = $(this).prev()[0].id.replace('-content', '');
				handleCursor($("#"+tabId), 1);
	            $(this).prev().fadeIn();

				if (idx === count-1) {
					$("#nextStep").removeClass("disabled");
				}
				return false;
			}
	    });
	}
	window.parent.iFrameHeight(1);
	handleButton();
});
$(document.body).on("click",".productTab", function( event ) {
	var contentId = $(this)[0].id + "-content",
	    count = $(".productTab").length;
	handleCursor($(this));

	$(".questionCenter").each(function(){
	    var me = $(this);
		
		if (me[0].id === contentId) {
		    if (me.is(':hidden')) {
		        me.fadeIn();
			}
			else {
			    return false;
			}
		}
		else if (me[0].id !== contentId && !me.is(':hidden')) {
		    me.hide();
		}
	});

	if ($(this)[0] === $(".productTab")[count-1]) {
	    handleFinishButton();
	}
	else {
	    $("#nextStep").removeClass("disabled");
	}
	handleButton();
	window.parent.iFrameHeight(1);
});
$(document.body).on("click",".optionIcon", function( event ) {
    var tabPage = $(this).closest(".questionCenter"),
	    count = $(".questionCenter").length;
    if ($(this).hasClass("selected")) {
	    $(this).removeClass("selected");
	}
	else {
	    tabPage.find(".optionIcon").removeClass("selected");
	    $(this).addClass("selected");
	}
    $(".questionCenter").each(function(idx){
	    if (!$(this).is(':hidden')) {

			if ($(this).next().hasClass('questionCenter')) {
			    $(this).hide();
			    var tabId = $(this).next()[0].id.replace('-content', '');
				handleCursor($("#"+tabId), 1);
                $(this).next().fadeIn();

				if (idx === count-2) {
				    handleFinishButton();
				}
			}
			return false;        
		}
    });
	handleFinished(tabPage);
	window.parent.iFrameHeight(1);
	handleButton();
});
$(document.body).on("blur","input", function( event ) {
    var tabPage = $(this).closest(".questionCenter");
	handleFinished(tabPage);
});
$(document.body).on("click",".finishedButton", function( event ) {
    var answetList = [];
    window.parent.muskCurrentPage();
    if (!$(this).hasClass("disabled")) {
        var paras = 'wishlistId=' + parent.wishlistId + '&level='+ parent.level;
	    generateQuestionList(answetList);
		$.ajax({
		    url: '/funeral/answer/add?' + paras,
			type: 'POST',
			contentType: "application/json; charset=UTF-8",
			dataType:'json',
			data: JSON.stringify(answetList),
			success:function(data){
                window.parent.updatePrice(data.price, data.originalPrice - data.price);
				window.parent.nextTab();
		    },
			error: function(error) {
				if (error.status === 200) {
                    window.parent.updatePrice(data.price);
                    window.parent.nextTab();
                }
			}
		});
	}
});
window.onload=function(){
    $(".questionCenter").first().fadeIn();
	handleButton();
};
</script>
</html>