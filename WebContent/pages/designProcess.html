<!DOCTYPE html>
<html>
<head>
<title>葬礼定制</title>
<script src="../js/jquery-2.1.4.js"></script>
<script src="../js/jquery-ui.js"></script>
<script src="../js/sliderx.js"></script>
<script src="../js/angular-1.4.0-rc.2/angular.js"></script>
<link href="../js/bootstrap-3.3.6-dist/css/bootstrap.css" rel="stylesheet">
<script src="../js/bootstrap-3.3.6-dist/js/bootstrap.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
</head>
<style>
@media (min-width: 900px) {
  .container {
    width: 1384px;
	padding: 0px;
	min-width: 1000px;
  }
}
.topBarDiv {
    box-shadow: 0px 2px 4px 0px rgba(162, 162, 162, 0.5);
	height: 65px;
	z-index: 1000;
}
p {
    margin: 0px;
}
#mainPage {
    width: 100%;
	overflow: auto;
	padding-bottom: 117px;
	background: #F6F6F6;
	z-index: 1;
	margin-top:2px;
}
#leftTabContent {
    float: left;
	width: 243px;
	overflow: auto;
	padding-top: 60px;
	margin-left: 100px;
	padding-bottom: 40px;
}
.tabTitle {
    width: 100%;
	height: 58px;
	padding-top: 25px;
	padding-left: 6px;
	border-bottom: 1px solid #9d9d9d;
}
.tabTitle p {
    font-size: 20px;
    color: #9d9d9d;
}
.normalTab {
    width: 100%;
	height: 50px;
	padding-left: 13px;
	border-radius: 3px;
	cursor: pointer;
}
.circleDiv {
    width: 24px;
	height: 24px;
	border-radius: 12px;
	background-color: #c6c6c6;
	float: left;
	margin-right: 14px;
	margin-top: 11px;
}
.titleDiv {
    height: 50px;
	overflow: auto;
	float: left;
}
.titleDiv p{
    font-size: 20px;
    color: #707070;
	line-height: 50px;
}
.selectedTab {
    background-color: #ff5274;
}
.selectedTab .circleDiv {
    background-color: #ffffff!important;
}
.selectedTab p {
    color: #ffffff!important;
}
.hoberdTab {
    background-color: #ff5274;
}
.hoberdTab .circleDiv {
    background-color: #ffffff!important;
}
.hoberdTab p {
    color: #ffffff!important;
}
.taocanDiv {
    width: 100%;
	height: 85px;
	padding-top: 15px;
	padding-left: 22px;
}
.taocaoDiv {
    font-size: 20px;
	color: #000000;
}
.priceDiv {
    font-size: 36px;
	line-height: 48px;
	color: #ff5274;
	font-weight: 200;
}
#rightContent {
    width: 950px;
	box-shadow: 0 -5px 15px 0 rgba(0, 0, 0, 0.1);
	background-color: #ffffff;
	float: left;
	margin-top: 29px;
}
#rightDsiplayContent {
    overflow: hidden;
}
</style>
<body>
<div class="topBarDiv">
    <IFRAME NAME="content_frame" width="100%" SRC="component/topBar.html?cat=design" frameborder =0 height = "65px"></IFRAME>
</div>
<div class="container">
<div id="mainPage">
<div id="leftTabContent">
    <div class="tabTitle">
	    <p>葬礼定制</p>
	</div>
	<div class="normalTab selectedTab" id="basicInfo">
	    <div class="circleDiv"></div>
		<div class="titleDiv">
	    <p>基础信息</p>
		</div>
	</div>
	<div class="normalTab" id="story">
	    <div class="circleDiv"></div>
		<div class="titleDiv">
	    <p>您的故事</p>
		</div>
	</div>
	<div class="normalTab" id="productAndService">
	    <div class="circleDiv"></div>
		<div class="titleDiv">
	    <p>产品和服务</p>
		</div>
	</div>
	<div class="normalTab" id="wishList">
	    <div class="circleDiv"></div>
		<div class="titleDiv">
	    <p>愿望清单</p>
		</div>
	</div>
	<div class="tabTitle">
	    <p>已选择套餐</p>
	</div>
	<div class="taocanDiv">
	    <p class="taocaoDiv">基础套餐</p>
		<p class="priceDiv">￥0</p>
	</div>
	<div class="taocanDiv">
	    <p class="taocaoDiv">节省金额</p>
		<p class="priceDiv">￥<span id="totalPrice">0<span></p>
	</div>
</div>
<div id="rightContent">
    <div id="rightDsiplayContent" overflow-y="visible">
	    <IFRAME width=100% marginwidth=0 marginheight=0 frameborder = 0 class="questionFrame" src="component/basicInfo.html" hidden></IFRAME>
		<IFRAME width=100% marginwidth=0 marginheight=0 frameborder = 0 class="questionFrame" src="component/questionsGroup.html" hidden></IFRAME>
		<IFRAME width=100% marginwidth=0 marginheight=0 frameborder = 0 class="questionFrame" id="productFrame" hidden></IFRAME>
		<IFRAME width=100% marginwidth=0 marginheight=0 frameborder = 0 class="questionFrame" name = "wishlistFrame" hidden></IFRAME>
		<IFRAME width=100% marginwidth=0 marginheight=0 frameborder = 0 class="questionFrame" src="component/finished.html" hidden></IFRAME>
	</div>
</div>
</div>
<IFRAME NAME="content_frame" width=100% height=300 marginwidth=0 marginheight=0 SRC="component/bottomBar.html" frameborder = 0></IFRAME>
</div>
</body>
<script type="text/javascript" language="javascript">
var wishList = [],
    originalWishlist = [],
    userId = 123,
	wishlistId;
function iFrameHeight(idx) {
    var height = $($('.questionFrame')[idx]).contents().find('#productMain')[0].offsetHeight;
	$($('.questionFrame')[idx]).css({
		height: height
	});
	if ($($('.questionFrame')[idx]).is(":visible")) {
	    $('#rightDsiplayContent').css({
		    height: height
	    });
	}
}
function flowToIndex(idx) {
    var height;
    $('.questionFrame').hide();
	$($('.questionFrame')[idx]).fadeIn();
    height = $($('.questionFrame')[idx]).contents().find('#productMain')[0].offsetHeight;
	$('#rightDsiplayContent').css({
		height: height
	});
}
function updatePrice(price, operator) {
    var currentPrice = parseInt($("#totalPrice")[0].innerText, 10),
        changedPrice;
    if (operator === '+') {
        changedPrice = currentPrice + price;
    }
    else {
        changedPrice = price;
    }
    $("#totalPrice").hide();
    $("#totalPrice")[0].innerText = changedPrice;
    $("#totalPrice").fadeIn();
}
function drillIntoNextTab(nextTab) {
    if (nextTab[0].id === 'productAndService') {
	    $($(".questionFrame")[2]).attr("src","component/product.html");
	}
	else if (nextTab[0].id === 'basicInfo') {
		flowToIndex(0);
	}
	else if (nextTab[0].id === 'wishList') {
		$($(".questionFrame")[3]).attr("src","component/wishList.html");
	}
	else if (nextTab[0].id === 'story') {
		flowToIndex(1);
	}
	$(".normalTab").removeClass("selectedTab");
	nextTab.addClass("selectedTab");
}
function updateWishList(nextTab) {
    $.ajax({
		url: '/funeral/wishlistDetail/list?wishlistId='+wishlistId,
	    type: 'GET',
		success:function(data){
		    var totalPrice = 0;
			wishList = data;
			for (var i=0;i<data.length;i++) {
			    totalPrice = totalPrice + data[i].price;
				originalWishlist.push(data[i]);
			}
			updatePrice(totalPrice);
			if (nextTab) {
			    drillIntoNextTab(nextTab);
			}
		},
		error: function(error) {
			//$("#messageSent")[0].value = '';
		}
    });
}
function getOrGenerateWishId() {
    $.ajax({
		url: '/funeral/wishlist/list?userId='+userId,
	    type: 'GET',
		success:function(data){
			wishlistId = data[0].wishlistId;
			updateWishList();
		},
		error: function(error) {
			//$("#messageSent")[0].value = '';
		}
    });
}
function compareWishlist() {
    if (originalWishlist.length !== wishList.length) {
	    return true;
	}
	else {
	    return !(originalWishlist.sort().toString() === wishList.sort().toString());
	}
}
function saveWishlist(nextTab) {
    if (compareWishlist()) {
        var finalItems = [];
	    for (var i=0;i<wishList.length;i++) {
		    var singleItem = wishList[i],
			    finalItem = {};
			
			finalItem.wishId = singleItem.wishId;
			finalItem.price = parseInt(singleItem.price, 10);
			finalItem.wishDesc = singleItem.wishDesc;
			finalItems.push(finalItem);
		}
	    $.ajax({
		    url: '/funeral/wishlistDetail/add?wishlistId='+parent.wishlistId,
			type: 'POST',
			contentType: "application/json; charset=UTF-8",
			dataType:'json',
			data: JSON.stringify(finalItems),
			success:function(data){
				drillIntoNextTab(nextTab);
				originalWishlist = [];
				for (var i=0;i<wishList.length;i++) {
				    originalWishlist.push(wishList[i]);
				}
		    },
			error: function(error) {
				//$("#messageSent")[0].value = '';
			}
		});
	}
	else if (nextTab){
	    drillIntoNextTab(nextTab);
	}
}
function saveProductFrameChange(nextTab) {
    var data = {},
		selectedItemList = [],
		selectElements = $("#productFrame").contents().find(".chooseProduct");

	selectElements.each(function() {
		var product = {
			wishId: $(this)[0].id,
			price: $(this).find('.detail').find('span')[0].innerText,
			wishName: $(this).find('.header')[0].innerText
		};
		selectedItemList.push(product);
	});
	wishList = selectedItemList;
	saveWishlist(nextTab);
}
function nextTab() {
	$(".normalTab").each(function() {
	    var me = $(this);

		if (me.hasClass("selectedTab")) {
		    me.removeClass("selectedTab");
			me.next().addClass("selectedTab");
			if (me.next()[0].id === 'productAndService') {
			    updateWishList(me.next());
			}
			else if (me.next()[0].id === 'wishList') {
			    saveProductFrameChange(me.next());
			}
			else if (me.next()[0].id === 'story') {
			    flowToIndex(1);
			}
			return false;
		}
	});
}
window.onload=function(){
	$(".normalTab").hover(function () {
        var $this = $(this);
		if (!$this.hasClass("hoberdTab")) {
            $this.addClass("hoberdTab");
		}
	});
	$(".normalTab").on("mouseleave", function () {
        var $this = $(this);

		if ($this.hasClass("hoberdTab")) {
            $this.removeClass("hoberdTab");
		}
	});
	$(".normalTab").click(function() {
	    var destUrl = "",
		    needSave = false,
			me = $(this);
			
		if ($(this).hasClass("selectedTab")) {
		    return false;
		}
		$(".normalTab").each(function() {
		    if ($(this).hasClass("selectedTab")) {
			    if ($(this)[0].id === 'productAndService') {
					saveProductFrameChange(me);
					needSave = true;
					return false;
				}
				else if ($(this)[0].id === 'wishList') {
					wishList = document.wishlistFrame.wishList;
					saveWishlist(me);
					needSave = true;
					return false;
				}
			}
		});
	    if (!needSave) {
		    drillIntoNextTab($(this));
		}
	});
	$(".normalTab").removeClass("selectedTab");
	$($(".normalTab")[0]).addClass("selectedTab");
	flowToIndex(0);
	getOrGenerateWishId();
};
</script> 
</html>