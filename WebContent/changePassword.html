 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="head">
<title>念念--修改密码</title>
<meta name="description" content="念念网致力于打造智能葬礼产品和服务定制工具。念念主张“不要让你爱的人走的太匆忙”，鼓励充分尊重逝者意愿的提前定制，已实现“殡葬服务价格透明化、互联网化、个性化”为己任 。念念，也是中国最大的日系骨灰盒骨灰坛销售公司，最有特色的祭扫祭祀用品服务商。" /> 
<meta name="keywords" content="念念,念念网,葬礼定制,殡葬,上海殡葬,殡葬服务,上海墓地， 骨灰盒，骨灰坛，寿衣，日本骨灰盒，葬礼花费，佛事服务，私人定制，生前契约，葬礼保险,提前定制" /> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<title>
</title>
</head>
<link href="/css/changePassword.css" rel="stylesheet">
<script src="../js/jquery-2.1.4.js"></script>
<script src="../js/jquery-ui.js"></script>
<script src="../js/sliderx.js"></script>
<script src="../js/angular-1.4.0-rc.2/angular.js"></script>
<script src="../js/Bootstrap/boot.js"></script>
<script src="../js/md5.js"></script>
<link href="../js/Bootstrap/boot.css" rel="stylesheet">
<script src="component/validation/index.js"></script>
<link href="component/validation/details.css" rel="stylesheet" type="text/css" />
<script src="/js/generalUsage.js"></script>
<body ng-app="signController" ng-controller="sign">
<div class="topBarDiv">
<IFRAME NAME="content_frame" width=100% SRC="component/topBar.html?cat=main" frameborder = 0 height = "67px"></IFRAME>
</div>
<div id="loginMain">
    <div id="topPart">
	    <div id="mainTitle">
		    <p>重置密码</p>
		</div>
	</div>
	<div id="inputArea">
	    <div id="errorContentCoat">
	        <div id="errorContent" hidden><p></p></div>
		</div>
	    <input type="text" class="form-control" placeholder="邮件或电话"  ng-model="user.userName" id="userName"></input>
		<div id="checkSmsCode">
		<input type="text" hidden width="200px" id="oldValidCode"></input>
			<input type="text" class="form-control" width="200px" id="validCode" placeholder="请输入短信验证码！" maxlength="6"></input>
		</div>
		<div id="smsSend"><p>发送</p></div>
		<input type="password" class="form-control" placeholder="密码"   ng-model="user.password" id="userPwd"></input>
		<input type="password" class="form-control" placeholder="重填密码" ng-model="repassword" id="confirmPwd"></input>
		<div class="ddetails-header">
			<div class="ddetails-con">
				<div id="code" >
					<input type="hidden"  id="J_down" data-link="http://sc.chinaz.com/">
					<div class="checkcode">
						<input type="text" id="J_codetext" placeholder="请输入验证码！" maxlength="4">
						<canvas class="J_codeimg" id="myCanvas" onclick="createCode()">
							Your browser does not support the canvas element.
						</canvas>
					</div>
				</div>
			</div>
        </div>
		<div id="submit">
		    <p>修改</p>
		</div>
	</div>
</div>
<IFRAME NAME="content_frame" width=100% height=294 marginwidth=0 marginheight=0 SRC="component/bottomBar.html" frameborder = 0></IFRAME>
</body>
<script type="text/javascript">
var length = location.search.length,
	backUrl = location.search.substring(11, length);
var app = angular.module('signController', []);
app.controller('sign', function($scope, $http) {
	
	$scope.user="";
	$scope.repassword="";
	$("#submit").click(function() {
		var user = $scope.user,
		    datadata;
		if (user === "" || user.userName === "") {
		    $("#errorContent").find("p")[0].innerText = '用户名不能为空';
	        $("#errorContent").fadeIn();
			$("#userName")[0].focus();
			return false;
		}
		else if(user==="" || user.validCode ===""){
			$("#errorContent").find("p")[0].innerText = '短信验证码不能为空';
	        $("#errorContent").fadeIn();
			$("#userName")[0].focus();
			return false;
		}
		else if (user === "" || user.password === ""){
		    $("#errorContent").find("p")[0].innerText = '密码不能为空';
	        $("#errorContent").fadeIn();
			$("#password")[0].focus();
			return false;
		}
		else if(user.validCode!=$("#validCode")[0].value){
			$("#errorContent").find("p")[0].innerText = '短信验证码不正确';
	        $("#errorContent").fadeIn();
			$("#userName")[0].focus();
			return false;
		}
		if (!validate()) {
		    return false;
		}
		user.password = hex_md5(user.password);
	    datadata = JSON.stringify($scope.user);
	    $http({
            method: "POST",
            url:"/sign/add",
            data: datadata,
			headers: {
                'Content-Type': 'application/json'
            },
			dataType:"json"
        }).success(function(data){
        	alert("修改成功!");
			window.location.href='needLogIn.html?returnUrl='+backUrl;
        });
	});	
	$("#smsSend").click(function() {
		var user = $scope.user,
	    datadata= JSON.stringify($scope.user);
		if (user === "" || user.userName === "") {
		    $("#errorContent").find("p")[0].innerText = '用户名不能为空';
	        $("#errorContent").fadeIn();
			$("#userName")[0].focus();
			return false;
		}
		$http({
            method: "POST",
            url:"/sign/send",
            data: datadata,
			headers: {
                'Content-Type': 'application/json'
            },
			dataType:"json"
        }).success(function(data){
        	if(user === "" || user.userId === ""){
        		alert("用户名不存在!");
        	}else{
        		user.validCode =data;
        		alert("短信验证码发送成功!");
        	}     	
        });
	});
});
function validateValid(content) {
    var emailFilter  = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,
	    phoneFilter = /^1\d{10}$/,
		message;
	if (content === "") {
	    return true;
	}
    if (emailFilter.test(content)) {
	    $("#errorContent").fadeOut();
	    return true;
	}

	if (phoneFilter.test(content)){
	    $("#errorContent").fadeOut();
	    return true;
	}
	$("#errorContent").find("p")[0].innerText = '您的用户名格式不正确';
	$("#errorContent").fadeIn();
	$("#userName")[0].focus();
	return false;
}
window.onload = function() {
	$("#alreadyHas").click(function() {
	    window.location.href='needLogIn.html';
	});
	$("#userName").blur(function() {
		if (!validateValid($(this)[0].value)) {
		    return false;
		}
		$.ajax({
		    url: '/sign/validate?userName='+$(this)[0].value,
			type: 'POST',
			contentType: "application/json; charset=UTF-8",
			dataType:'json',
			data: [],
			success:function(data){
                var resultCode =data.resultCode;

				if (resultCode === 0) {
					 $("#errorContent").find("p")[0].innerText = '用户名不存在！';
		                $("#errorContent").fadeIn();
						$("#userName")[0].focus();
				}
				else{
					 $("#errorContent").fadeOut();
				}
		    },
			error: function(error) {
			}
		});
	});
	$("#confirmPwd").blur(function() {
	    var pwd = $("#userPwd")[0].value,
		    confirmPwd = $("#confirmPwd")[0].value;
		
		if (pwd !== confirmPwd && pwd !== "" && confirmPwd !== "") {
		    $("#errorContent").find("p")[0].innerText = '两次输入的密码不匹配';
	        $("#errorContent").fadeIn();
	        $("#confirmPwd")[0].focus();
		}
		else {
		    $("#errorContent").fadeOut();
		}
	});
}
</script>
</html>